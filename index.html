
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XENORUN: OMEGA</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            margin: 0;
            padding: 0;
            background-color: #050510;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            font-family: 'Press Start 2P', cursive;
            color: #fff;
            user-select: none;
        }

        #gameWrapper {
            position: relative;
            width: 960px;
            height: 540px;
            box-shadow: 0 0 50px rgba(0, 255, 128, 0.2), 0 0 0 10px #1a1a2e;
            background: #000;
            overflow: hidden;
            border-radius: 4px;
        }

        canvas { display: block; image-rendering: pixelated; width: 100%; height: 100%; }

        /* UI Overlays */
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: rgba(0, 0, 0, 0.85); z-index: 10; transition: opacity 0.3s;
        }

        .hidden { opacity: 0; pointer-events: none; }

        h1 {
            font-size: 40px; color: #00ff88; text-shadow: 4px 4px #ff0055;
            margin-bottom: 20px; text-transform: uppercase; letter-spacing: 2px;
        }

        p { font-size: 14px; line-height: 1.8; color: #ccc; text-align: center; max-width: 600px; }

        .blink { animation: blinker 1s linear infinite; color: #fff; margin-top: 30px; font-size: 12px; }
        @keyframes blinker { 50% { opacity: 0; } }

        #scoreHud {
            position: absolute; top: 20px; right: 20px;
            font-size: 16px; z-index: 5; text-shadow: 2px 2px #000; color: #00ff88;
        }

        #scanlines {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
            background-size: 100% 4px; pointer-events: none; z-index: 20;
        }

        /* Input Styles */
        input { background: #333; border: 2px solid #00ff88; color: #fff; padding: 10px; font-family: inherit; margin-top: 10px; text-transform: uppercase; text-align: center; }
        button { background: #00ff88; color: #000; border: none; padding: 10px 20px; font-family: inherit; margin-top: 10px; cursor: pointer; }
        button:hover { background: #fff; }

        .leaderboard-box { margin-top: 20px; font-size: 10px; color: #aaa; text-align: left; }
        .lb-row { display: flex; justify-content: space-between; width: 300px; margin-bottom: 4px; }
        .lb-row:nth-child(1) { color: #ff0055; }
    </style>
</head>
<body>

<div id="gameWrapper">
    <div id="scoreHud">SCORE: <span id="scoreVal">00000</span></div>
    
    <div id="startScreen" class="overlay">
        <h1>XENORUN</h1>
        <p>SECTOR 7G IS COLLAPSING.</p>
        <p>[SPACE] to JUMP / DOUBLE JUMP<br>[X] to FIRE BLASTER</p>
        <div class="blink">CLICK HERE THEN PRESS SPACE</div>
        <div class="leaderboard-box" id="startLeaderboard">Loading Ranks...</div>
    </div>

    <div id="gameOverScreen" class="overlay hidden">
        <h1 style="color:#ff0055; text-shadow:4px 4px #fff;">CRITICAL FAILURE</h1>
        <p>FINAL SCORE: <span id="finalScore">0</span></p>
        <input type="text" id="playerName" placeholder="INIT" maxlength="3">
        <button id="submitBtn" onclick="submitScore()">UPLOAD TO NET</button>
        <button onclick="resetGame()" style="background:transparent; color:#fff; border:1px solid #fff; margin-top:5px;">RETRY</button>
    </div>

    <canvas id="gameCanvas" width="960" height="540"></canvas>
    <div id="scanlines"></div>
</div>

<script>
/**
 * ------------------------------------------------------------------
 * CONFIGURATION
 * ------------------------------------------------------------------
 */
// PASTE YOUR GOOGLE SCRIPT WEB APP URL HERE
const LEADERBOARD_URL = "https://script.google.com/macros/s/AKfycbyPAOLu61io_asry-ThXGVjqYbmCTN7DtvSvvAyl25J1DROrta614m_uXGTDMFqwomv/exec"; 

const C = document.getElementById('gameCanvas');
const ctx = C.getContext('2d');
const WIDTH = C.width;
const HEIGHT = C.height;

// Audio Context
const AudioContext = window.AudioContext || window.webkitAudioContext;
const audioCtx = new AudioContext();

/**
 * ------------------------------------------------------------------
 * AUDIO ENGINE (8-BIT SYNTH)
 * ------------------------------------------------------------------
 */
const Sound = {
    playTone: (freq, type, duration, vol=0.1) => {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(vol, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + duration);
    },
    jump: () => {
        // Classic Mario-style slide
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'square';
        osc.frequency.setValueAtTime(150, audioCtx.currentTime);
        osc.frequency.linearRampToValueAtTime(300, audioCtx.currentTime + 0.1);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.1);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 0.1);
    },
    shoot: () => {
        Sound.playTone(600, 'sawtooth', 0.1, 0.05);
    },
    explode: () => {
        // Noise burst
        const bufferSize = audioCtx.sampleRate * 0.3;
        const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
        const data = buffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
        const noise = audioCtx.createBufferSource();
        noise.buffer = buffer;
        const gain = audioCtx.createGain();
        gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
        noise.connect(gain); gain.connect(audioCtx.destination);
        noise.start();
    },
    musicTick: (frame) => {
        // Procedural Bassline
        if (frame % 15 === 0) {
            const notes = [110, 110, 130, 98]; // A, A, C, G (Bass)
            const note = notes[Math.floor((frame / 15) % 4)];
            Sound.playTone(note, 'triangle', 0.1, 0.05);
        }
    }
};

/**
 * ------------------------------------------------------------------
 * ASSETS & GRAPHICS
 * ------------------------------------------------------------------
 */
function createAsset(w, h, drawFn) {
    const c = document.createElement('canvas'); c.width = w; c.height = h;
    const x = c.getContext('2d'); drawFn(x, w, h); return c;
}

const Assets = {
    playerRun1: createAsset(40, 40, (c) => {
        c.fillStyle='#00ff88'; c.fillRect(10,5,20,20); // Head
        c.fillStyle='#fff'; c.fillRect(15,10,15,10); // Visor
        c.fillStyle='#444'; c.fillRect(12,25,16,15); // Body
        c.fillStyle='#555'; c.fillRect(10,40,8,8); c.fillRect(22,35,8,8); // Legs
    }),
    playerRun2: createAsset(40, 40, (c) => {
        c.fillStyle='#00ff88'; c.fillRect(10,6,20,20);
        c.fillStyle='#fff'; c.fillRect(15,11,15,10);
        c.fillStyle='#444'; c.fillRect(12,26,16,15);
        c.fillStyle='#555'; c.fillRect(10,35,8,8); c.fillRect(22,40,8,8);
    }),
    playerJump: createAsset(40, 40, (c) => {
        c.fillStyle='#00ff88'; c.fillRect(10,5,20,20);
        c.fillStyle='#fff'; c.fillRect(15,10,15,10);
        c.fillStyle='#444'; c.fillRect(12,25,16,15);
        c.fillStyle='#ff9900'; c.fillRect(10,42,6,6); c.fillRect(24,42,6,6); // Jets
    }),
    enemyGround: createAsset(50, 40, (c, w, h) => {
        c.fillStyle='#80f'; c.beginPath(); c.moveTo(0,h); c.lineTo(10,10); c.lineTo(40,10); c.lineTo(50,h); c.fill();
        c.fillStyle='#f05'; c.fillRect(15,15,20,5); // Eye
        c.fillStyle='#408'; c.fillRect(0,35,50,5); // Tracks
    }),
    enemyAir: createAsset(50, 30, (c) => {
        c.fillStyle='#555'; c.beginPath(); c.ellipse(25,15,25,10,0,0,Math.PI*2); c.fill();
        c.fillStyle='#0ff'; c.beginPath(); c.ellipse(25,10,10,8,0,0,Math.PI*2); c.fill();
        c.fillStyle='#f05'; c.fillRect(5,15,5,5); c.fillRect(40,15,5,5);
    }),
    bullet: createAsset(20, 6, (c) => {
        c.fillStyle='#fff'; c.fillRect(0,0,20,6);
        c.fillStyle='#00ff88'; c.fillRect(2,2,16,2);
    }),
    ground: createAsset(100, 100, (c, w, h) => {
        c.fillStyle='#1a1a2e'; c.fillRect(0,0,w,h);
        c.fillStyle='#252540'; c.fillRect(0,0,w,4);
        c.fillStyle='#335'; c.fillRect(20,20,60,10); c.fillRect(50,50,10,30);
    })
};

/**
 * ------------------------------------------------------------------
 * GAME CLASSES
 * ------------------------------------------------------------------
 */
class ParallaxLayer {
    constructor(speedMod, color, heightMod) {
        this.speedMod = speedMod; this.color = color; this.x = 0;
        this.skyline = [];
        for(let i=0; i<30; i++) this.skyline.push({ w: 50+Math.random()*100, h: 50+Math.random()*heightMod });
    }
    update() { this.x -= gameSpeed * this.speedMod; if (this.x <= -1000) this.x = 0; }
    draw() {
        ctx.fillStyle = this.color;
        let curX = this.x;
        for(let r=0; r<3; r++) {
            this.skyline.forEach(b => { ctx.fillRect(curX, HEIGHT-50-b.h, b.w+2, b.h); curX += b.w; });
        }
    }
}

class Particle {
    constructor(x, y, color) {
        this.x = x; this.y = y; this.color = color;
        this.size = Math.random()*4+2;
        this.vx = (Math.random()-0.5)*10; this.vy = (Math.random()-0.5)*10;
        this.life = 1.0;
    }
    update() {
        this.x += this.vx - gameSpeed; this.y += this.vy;
        this.vx *= 0.9; this.vy *= 0.9; this.life -= 0.05;
    }
    draw() {
        ctx.globalAlpha = Math.max(0, this.life); ctx.fillStyle = this.color;
        ctx.fillRect(this.x, this.y, this.size, this.size); ctx.globalAlpha = 1.0;
    }
}

class Bullet {
    constructor(x, y) {
        this.x = x; this.y = y; this.w = 20; this.h = 6;
        this.dead = false;
    }
    update() { this.x += 15; if(this.x > WIDTH) this.dead = true; }
    draw() { ctx.drawImage(Assets.bullet, this.x, this.y); }
}

class Player {
    constructor() {
        this.w = 40; this.h = 40; this.x = 100; this.y = HEIGHT-100;
        this.dy = 0; this.grounded = false; this.canDoubleJump = false;
        this.animTimer = 0;
    }
    jump() {
        if (this.grounded) {
            this.dy = -13; this.grounded = false; this.canDoubleJump = true;
            Sound.jump();
            spawnParticles(this.x+20, this.y+40, '#fff', 5);
        } else if (this.canDoubleJump) {
            this.dy = -13; this.canDoubleJump = false;
            Sound.jump();
            spawnParticles(this.x+20, this.y+40, '#f90', 8);
        }
    }
    shoot() {
        bullets.push(new Bullet(this.x + 30, this.y + 20));
        Sound.shoot();
        spawnParticles(this.x+40, this.y+20, '#0f8', 3);
    }
    update() {
        this.dy += 0.6; this.y += this.dy;
        if (this.y + this.h > HEIGHT - 50) {
            this.y = HEIGHT - 50 - this.h; this.dy = 0; this.grounded = true; this.canDoubleJump = false;
        } else { this.grounded = false; }
        this.animTimer++;
    }
    draw() {
        let sprite = (!this.grounded) ? Assets.playerJump : 
                     (Math.floor(this.animTimer/8)%2===0) ? Assets.playerRun1 : Assets.playerRun2;
        ctx.drawImage(sprite, this.x, this.y, this.w, this.h);
    }
}

class Obstacle {
    constructor() {
        this.type = Math.random()>0.5 ? 'ground' : 'air';
        this.w = 50; this.h = this.type==='ground'?40:30;
        this.x = WIDTH + 50;
        this.y = this.type==='ground' ? HEIGHT-50-this.h : HEIGHT-180;
        this.dead = false;
    }
    update() { this.x -= gameSpeed; if (this.x < -50) this.dead = true; }
    draw() { ctx.drawImage(this.type==='ground'?Assets.enemyGround:Assets.enemyAir, this.x, this.y, this.w, this.h); }
}

/**
 * ------------------------------------------------------------------
 * GAME LOOP
 * ------------------------------------------------------------------
 */
let gameState = 'START';
let gameSpeed = 6, score = 0, frames = 0, shake = 0;
let player, obstacles, bullets, particles, bgLayers;

function init() {
    player = new Player();
    obstacles = []; bullets = []; particles = [];
    bgLayers = [ new ParallaxLayer(0.2, '#112', 150), new ParallaxLayer(0.5, '#224', 80) ];
    score = 0; gameSpeed = 6; frames = 0;
    fetchLeaderboard();
}

function spawnParticles(x, y, c, n) { for(let i=0; i<n; i++) particles.push(new Particle(x, y, c)); }

function loop() {
    if (gameState !== 'PLAYING') return;
    
    // Audio Loop
    Sound.musicTick(frames);

    // Screen Shake & Clear
    ctx.setTransform(1,0,0,1,0,0);
    if(shake > 0) { ctx.translate(Math.random()*shake - shake/2, Math.random()*shake - shake/2); shake *= 0.9; if(shake<0.5) shake=0; }
    ctx.clearRect(0, 0, WIDTH, HEIGHT);

    // Updates
    gameSpeed += 0.001; score++; frames++;
    document.getElementById('scoreVal').innerText = score.toString().padStart(5,'0');

    // Draw Background
    bgLayers.forEach(l => { l.update(); l.draw(); });

    // Draw Ground
    let gOff = -(frames*gameSpeed)%100;
    for(let i=0; i<WIDTH/100+2; i++) ctx.drawImage(Assets.ground, gOff+(i*100), HEIGHT-50);

    // Player
    player.update(); player.draw();

    // Bullets
    bullets.forEach(b => { b.update(); b.draw(); });
    bullets = bullets.filter(b => !b.dead);

    // Obstacles
    if(frames % 60 === 0 && Math.random() < 0.05 + (score*0.00005)) obstacles.push(new Obstacle());
    
    obstacles.forEach(obs => {
        obs.update(); obs.draw();
        
        // Bullet Hit Enemy
        bullets.forEach(b => {
            if(!b.dead && !obs.dead && 
               b.x < obs.x+obs.w && b.x+b.w > obs.x && b.y < obs.y+obs.h && b.y+b.h > obs.y) {
                b.dead = true; obs.dead = true;
                Sound.explode(); shake = 5;
                spawnParticles(obs.x+25, obs.y+20, '#f05', 10);
                score += 500;
            }
        });

        // Player Hit Enemy
        if (!obs.dead &&
            player.x+10 < obs.x+obs.w-10 && player.x+player.w-10 > obs.x+10 &&
            player.y+10 < obs.y+obs.h-10 && player.y+player.h-10 > obs.y+10
        ) {
            Sound.explode();
            gameState = 'GAMEOVER';
            document.getElementById('gameOverScreen').classList.remove('hidden');
            document.getElementById('finalScore').innerText = score;
        }
    });
    obstacles = obstacles.filter(o => !o.dead);

    // Particles
    particles.forEach(p => { p.update(); p.draw(); });
    particles = particles.filter(p => p.life > 0);

    requestAnimationFrame(loop);
}

// Controls
function resetGame() {
    init();
    gameState = 'PLAYING';
    document.getElementById('startScreen').classList.add('hidden');
    document.getElementById('gameOverScreen').classList.add('hidden');
    if(audioCtx.state === 'suspended') audioCtx.resume();
    loop();
}

window.addEventListener('keydown', e => {
    if(e.code === 'Space') {
        if(gameState !== 'PLAYING') resetGame();
        else player.jump();
    }
    if(e.code === 'KeyX' && gameState === 'PLAYING') player.shoot();
});

// Touch (Mobile)
window.addEventListener('touchstart', e => {
    if(gameState !== 'PLAYING') resetGame();
    else player.jump();
});

/**
 * ------------------------------------------------------------------
 * LEADERBOARD LOGIC
 * ------------------------------------------------------------------
 */
async function fetchLeaderboard() {
    if(LEADERBOARD_URL.includes("PASTE")) return;
    try {
        const res = await fetch(LEADERBOARD_URL);
        const data = await res.json();
        const html = data.map((row, i) => 
            `<div class="lb-row"><span>#${i+1} ${row[0]}</span><span>${row[1]}</span></div>`
        ).join('');
        document.getElementById('startLeaderboard').innerHTML = "TOP AGENTS:<br>" + html;
    } catch(e) { console.log("Leaderboard offline"); }
}

async function submitScore() {
    const name = document.getElementById('playerName').value;
    if(!name) return alert("ENTER NAME!");
    const btn = document.getElementById('submitBtn');
    btn.innerText = "SENDING...";
    try {
        await fetch(LEADERBOARD_URL, {
            method: 'POST', mode: 'no-cors',
            body: JSON.stringify({ name: name, score: score })
        });
        alert("UPLOADED!"); location.reload();
    } catch(e) { alert("ERROR"); }
}

init();
</script>
</body>
</html>