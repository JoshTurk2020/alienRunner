<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>XENORUN: GIF EDITION</title>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
    
    * { box-sizing: border-box; touch-action: none; }
    
    body { 
        margin: 0; background: #111; overflow: hidden; 
        font-family: 'Press Start 2P', cursive; color: #fff; 
        display: flex; justify-content: center; align-items: center; 
        height: 100vh; user-select: none; 
    }

    #gameWrapper { 
        position: relative; 
        width: 100%; max-width: 800px; 
        aspect-ratio: 16/9;
        background: #000; 
        border: 4px solid #333; 
        box-shadow: 0 0 50px rgba(0,0,0,0.5); 
        overflow: hidden; /* Keeps the GIF inside */
    }

    canvas { width: 100%; height: 100%; display: block; image-rendering: pixelated; }

    /* THE PLAYER GIF OVERLAY */
    #playerGif {
        position: absolute;
        width: 10%; /* Relative size to screen */
        height: auto;
        z-index: 5;
        display: none; /* Hidden until game starts */
        pointer-events: none;
        image-rendering: pixelated; /* Keeps pixel art crisp */
    }

    /* UI Overlay */
    .overlay { 
        position: absolute; top:0; left:0; width:100%; height:100%; 
        background: rgba(0,0,0,0.85); 
        display: flex; flex-direction: column; align-items: center; justify-content: center; 
        z-index: 20; 
    }
    .hidden { opacity: 0; pointer-events: none; }
    
    h1 { font-size: 40px; color: #fc0; text-shadow: 4px 4px #f00; margin-bottom: 20px; text-align: center; } 
    .hud { position: absolute; top: 10px; left: 10px; right: 10px; display: flex; justify-content: space-between; font-size: 14px; color: #fff; z-index: 5; pointer-events: none; }
    
    /* Mobile Fire Button */
    .fire-btn { 
        position: absolute; bottom: 30px; right: 30px; 
        width: 80px; height: 80px; border-radius: 50%; 
        background: rgba(255,0,0,0.5); border: 2px solid #f00; color:white; 
        display:flex; align-items:center; justify-content:center; z-index:15; 
        font-size: 12px;
    }
    .fire-btn:active { background: #f00; }

    input { background: #000; border: 2px solid #fc0; color: #fc0; padding: 10px; font-family: inherit; font-size: 16px; width: 250px; text-align: center; margin-top: 10px; text-transform: uppercase; }
    button { background: #fc0; color: #000; border: none; padding: 15px 20px; font-family: inherit; font-size: 14px; margin-top: 15px; cursor: pointer; }
    button:hover { background: #fff; }

</style>
</head>
<body>

<div id="gameWrapper">
    <div class="hud">
        <span>SCORE: <span id="scoreVal">0</span></span>
        <span>LVL: <span id="lvlVal">1</span></span>
    </div>

    <img id="playerGif" src="player.gif" alt="Player">

    <div id="startScreen" class="overlay">
        <h1>XENORUN<br><span style="font-size:15px; color:#fff;">GIF EDITION</span></h1>
        <div style="text-align:center; font-size:10px; color:#aaa; line-height:2; margin-bottom:20px;">
            INSTRUCTIONS:<br>
            1. NAME YOUR FILE 'player.gif'<br>
            2. PLACE IN SAME FOLDER<br>
            <br>
            CONTROLS: [SPACE] JUMP | [X] SHOOT
        </div>
        <button onclick="startGame()">START GAME</button>
        <div style="margin-top:10px; font-size:10px; color:#666;" id="statusMsg">Checking for player.gif...</div>
    </div>

    <div id="gameOverScreen" class="overlay hidden">
        <h1 style="color:#e44;">GAME OVER</h1>
        <p>SCORE: <span id="finalScore">0</span></p>
        <input type="text" id="playerName" placeholder="NAME" maxlength="15">
        <button onclick="submitScore()" id="subBtn">SUBMIT</button>
        <button onclick="location.reload()" style="background:#000; color:#fff; border:1px solid #fff;">RETRY</button>
    </div>

    <div class="fire-btn" id="mobFire">FIRE</div>
    <canvas id="c"></canvas>
</div>

<script>
// --- CONFIGURATION ---
const LEADERBOARD_URL = "https://script.google.com/macros/s/AKfycbyPAOLu61io_asry-ThXGVjqYbmCTN7DtvSvvAyl25J1DROrta614m_uXGTDMFqwomv/exec"; 

// --- CHECK FOR GIF ---
const pGif = document.getElementById('playerGif');
pGif.onload = () => {
    document.getElementById('statusMsg').innerText = "GIF FOUND! READY TO RUN.";
    document.getElementById('statusMsg').style.color = "#0f0";
};
pGif.onerror = () => {
    document.getElementById('statusMsg').innerText = "WARNING: player.gif NOT FOUND";
    document.getElementById('statusMsg').style.color = "red";
};

// --- AUDIO ---
const Actx = window.AudioContext||window.webkitAudioContext; const actx = new Actx();
const SFX = {
    play: (f,t,d,v=0.1) => {
        if(actx.state==='suspended')actx.resume();
        const o=actx.createOscillator(), g=actx.createGain();
        o.type=t; o.frequency.value=f; g.gain.setValueAtTime(v, actx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, actx.currentTime+d);
        o.connect(g); g.connect(actx.destination); o.start(); o.stop(actx.currentTime+d);
    },
    boom: () => {
        const b=actx.createBuffer(1, actx.sampleRate*0.2, actx.sampleRate);
        const d=b.getChannelData(0); for(let i=0;i<d.length;i++)d[i]=Math.random()*2-1;
        const s=actx.createBufferSource(); s.buffer=b; 
        const g=actx.createGain(); g.gain.value=0.2; g.gain.exponentialRampToValueAtTime(0.01, actx.currentTime+0.2);
        s.connect(g); g.connect(actx.destination); s.start();
    }
};

// --- GAME LOGIC ---
const C = document.getElementById('c'), ctx = C.getContext('2d');
// Internal resolution (NES Style)
const W = 320; 
const H = 180;
C.width = W; C.height = H;

let state='MENU', frames=0, score=0, difficulty=1, player={x:30,y:120,dy:0,grounded:true};
let entities=[], bullets=[], stars=[];

// Init Stars
for(let i=0;i<40;i++)stars.push({x:Math.random()*W,y:Math.random()*120,s:Math.random()>0.8?2:1});

// Code-generated Enemies
const PAL = { p:'#a4e', r:'#e44', w:'#fff' };
const MAPS = {
    alien: ["  444 "," 44444","444544","44444 "," 4  4 ","4 44 4"],
    drone: [" 4444 ","445544","444444"," 4  4 "]
};
function makeSprite(map) {
    const cvs = document.createElement('canvas'); cvs.width=16; cvs.height=16;
    const cx=cvs.getContext('2d');
    map.forEach((r,y)=>{ for(let x=0;x<r.length;x++) {
        let c=r[x]; if(c==='4')cx.fillStyle=PAL.p; if(c==='5')cx.fillStyle=PAL.r;
        if(c!==' ')cx.fillRect(x*2,y*2,2,2);
    }}); return cvs;
}
const IMG = { alien: makeSprite(MAPS.alien), drone: makeSprite(MAPS.drone) };


function startGame() {
    state='PLAYING'; score=0; frames=0; difficulty=1; entities=[]; bullets=[];
    document.getElementById('startScreen').classList.add('hidden');
    // Show the GIF
    pGif.style.display = "block";
    loop();
}

function loop() {
    if(state!=='PLAYING') return;
    frames++; score++;
    if(score%500===0) difficulty++;
    document.getElementById('scoreVal').innerText = score.toString().padStart(5,'0');
    document.getElementById('lvlVal').innerText = difficulty;

    let speed = 2 + (difficulty*0.2); if(speed>6) speed=6;

    // Physics
    player.dy += 0.25; player.y += player.dy;
    // Floor collision
    if(player.y >= 135) { player.y=135; player.dy=0; player.grounded=true; } else player.grounded=false;

    // UPDATE GIF POSITION (Use Percentages to match Canvas)
    // Convert game coordinates (320x180) to CSS percentages
    pGif.style.left = (player.x / W * 100) + '%';
    pGif.style.top = ((player.y - 10) / H * 100) + '%'; // -10 offset for GIF height

    // Spawning
    if(frames % Math.floor(100-(difficulty*5)) === 0) {
        let type = Math.random()>0.7 ? 'drone' : 'alien';
        entities.push({type:type, x:W, y:type==='drone'?100:135, w:12, h:12, dead:false});
    }

    // DRAW
    ctx.fillStyle='#111'; ctx.fillRect(0,0,W,H); // BG
    
    // Stars
    ctx.fillStyle='#fff'; stars.forEach(s=>{ s.x-=speed*(s.s===2?0.5:0.2); if(s.x<0)s.x=W; ctx.fillRect(s.x,s.y,s.s,s.s); });

    // Floor
    ctx.fillStyle='#333'; ctx.fillRect(0,150,W,30); ctx.fillStyle='#fc0'; ctx.fillRect(0,150,W,2);

    // Entities
    entities.forEach(e=>{
        e.x -= speed;
        ctx.drawImage(IMG[e.type], e.x, e.y);
        // Collision
        if(!e.dead && player.x < e.x+10 && player.x+10 > e.x && player.y < e.y+10 && player.y+10 > e.y) gameOver();
    });

    // Bullets
    bullets.forEach(b=>{
        b.x+=4; ctx.fillStyle='#ff0'; ctx.fillRect(b.x,b.y,4,2);
        entities.forEach(e=>{
            if(!e.dead && !b.dead && b.x < e.x+12 && b.x+4 > e.x && b.y < e.y+12 && b.y+2 > e.y) {
                e.dead=true; b.dead=true; score+=100; SFX.boom();
            }
        });
    });

    entities = entities.filter(e=>e.x>-20 && !e.dead);
    bullets = bullets.filter(b=>b.x<320 && !b.dead);

    requestAnimationFrame(loop);
}

function gameOver() {
    state='GAMEOVER'; SFX.play(50,'sawtooth',0.5);
    document.getElementById('finalScore').innerText=score;
    document.getElementById('gameOverScreen').classList.remove('hidden');
    pGif.style.display = "none"; // Hide GIF on death
}

function jump() { if(player.grounded) { player.dy=-4.5; player.grounded=false; SFX.play(200,'square',0.1); } }
function shoot() { bullets.push({x:player.x+10, y:player.y+8, dead:false}); SFX.play(600,'square',0.05); }

// Controls
window.addEventListener('keydown', e=>{ if(e.code==='Space')jump(); if(e.code==='KeyX')shoot(); });
document.getElementById('gameWrapper').addEventListener('touchstart', e=>{
    if(e.target.id!=='mobFire' && e.target.tagName!=='BUTTON') jump();
});
document.getElementById('mobFire').addEventListener('mousedown', (e)=>{ e.stopPropagation(); shoot(); });
document.getElementById('mobFire').addEventListener('touchstart', (e)=>{ e.stopPropagation(); e.preventDefault(); shoot(); });

// Leaderboard
async function submitScore() {
    let n = document.getElementById('playerName').value; if(!n) return alert("NAME?");
    document.getElementById('subBtn').innerText = "...";
    try {
        await fetch(LEADERBOARD_URL, {method:'POST', mode:'no-cors', body:JSON.stringify({name:n, score:score})});
        alert("SENT"); location.reload();
    } catch(e) { alert("ERROR"); }
}
</script>
</body>
</html>
