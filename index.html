<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>XENORUN: OMEGA</title>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
    body { margin: 0; background: #050510; overflow: hidden; font-family: 'Press Start 2P', cursive; color: #fff; display: flex; justify-content: center; align-items: center; height: 100vh; user-select: none; }
    #gameWrapper { position: relative; width: 960px; height: 540px; box-shadow: 0 0 60px rgba(0, 255, 136, 0.1); background: #000; border: 4px solid #222; border-radius: 4px; }
    canvas { display: block; image-rendering: pixelated; width: 100%; height: 100%; }
    .overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; transition: opacity 0.3s; }
    .hidden { opacity: 0; pointer-events: none; }
    h1 { font-size: 48px; color: #00ff88; text-shadow: 4px 4px #ff0055; margin-bottom: 20px; }
    #scoreHud { position: absolute; top: 20px; right: 20px; font-size: 16px; color: #00ff88; text-shadow: 2px 2px #000; z-index: 5; }
    
    /* Inputs */
    input { background: #222; border: 2px solid #00ff88; color: #fff; padding: 15px; font-family: inherit; margin-top: 10px; text-transform: uppercase; text-align: center; font-size: 16px; width: 300px; }
    button { background: #00ff88; color: #000; border: none; padding: 15px 30px; font-family: inherit; margin-top: 15px; cursor: pointer; font-size: 16px; transition: transform 0.1s; }
    button:hover { background: #fff; transform: scale(1.05); }
    
    .leaderboard-box { margin-top: 30px; font-size: 10px; color: #aaa; text-align: left; width: 400px; }
    .lb-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #333; }
    .lb-row:nth-child(1) { color: #ff0055; }
</style>
</head>
<body>

<div id="gameWrapper">
    <div id="scoreHud">SCORE: <span id="scoreVal">0</span></div>
    
    <div id="startScreen" class="overlay">
        <h1>XENORUN</h1>
        <div style="color:#aaa; font-size:12px; margin-bottom:20px; line-height:1.6; text-align:center;">
            MISSION: SURVIVE THE HIVE<br>
            [SPACE] JUMP / JETPACK &nbsp; | &nbsp; [X] BLASTER
        </div>
        <button onclick="startGame()">DEPLOY MARINE</button>
        <div class="leaderboard-box" id="startLeaderboard">CONNECTING TO NET...</div>
    </div>

    <div id="gameOverScreen" class="overlay hidden">
        <h1 style="color:#ff0055;">K.I.A.</h1>
        <p>FINAL SCORE: <span id="finalScore">0</span></p>
        <input type="text" id="playerName" placeholder="ENTER FULL NAME" maxlength="15">
        <button id="submitBtn" onclick="submitScore()">UPLOAD RECORD</button>
        <button onclick="resetGame()" style="background:transparent; color:#fff; border:1px solid #555; margin-top:10px; font-size:12px;">RETRY MISSION</button>
    </div>

    <canvas id="c"></canvas>
</div>

<script>
/**
 * ------------------------------------------------------------------
 * 1. CONFIGURATION
 * ------------------------------------------------------------------
 */
// *** PASTE YOUR GOOGLE WEB APP URL BELOW ***
const LEADERBOARD_URL = "https://script.google.com/macros/s/AKfycbyPAOLu61io_asry-ThXGVjqYbmCTN7DtvSvvAyl25J1DROrta614m_uXGTDMFqwomv/exec"; 

const C = document.getElementById('c');
const ctx = C.getContext('2d');
C.width = 960; C.height = 540;

const PALETTE = {
    green: '#00ff88', dark: '#1a1a2e', skin: '#ffccaa',
    armor: '#444455', visor: '#ccffff',
    alien: '#a0f', alienEye: '#f05',
    bullet: '#fff'
};

/**
 * ------------------------------------------------------------------
 * 2. PIXEL ART ENGINE
 * ------------------------------------------------------------------
 * We draw text maps into Canvases to create sprites
 */
const SpriteMaps = {
    // 12x12 Pixel Grid
    marineRun1: [
        "......4444..",
        "......4334..",
        "......4334..",
        ".....444444.",
        "....4411444.",
        "...4441144..",
        "..4444114...",
        "..4.44444...",
        "....4...4...",
        "...4....4...",
        "...4....4...",
        "..44....44.."
    ],
    marineRun2: [
        "......4444..",
        "......4334..",
        "......4334..",
        ".....444444.",
        "....4411444.",
        "...4441144..",
        "..4444114...",
        "..4.44444...",
        "....4...44..",
        "...44...4...",
        "...4........",
        "..44........"
    ],
    alien: [
        "......555...",
        "....555555..",
        "...55555555.",
        "..556555555.",
        ".55555555...",
        ".555555.....",
        "..5555......",
        "..5.5.......",
        ".5..5.......",
        "55..55......"
    ],
    drone: [
        ".....555....",
        "...556555...",
        "..55555555..",
        ".5555555555.",
        "............",
        ".4...4..4...",
        ".4...4..4..."
    ]
};

function parseSprite(map, scale=4) {
    const w = map[0].length * scale;
    const h = map.length * scale;
    const canvas = document.createElement('canvas');
    canvas.width = w; canvas.height = h;
    const cx = canvas.getContext('2d');
    
    const colorMap = {
        '1': PALETTE.green, '3': PALETTE.visor, '4': PALETTE.armor,
        '5': PALETTE.alien, '6': PALETTE.alienEye
    };

    map.forEach((row, y) => {
        row.split('').forEach((char, x) => {
            if (colorMap[char]) {
                cx.fillStyle = colorMap[char];
                cx.fillRect(x * scale, y * scale, scale, scale);
            }
        });
    });
    return canvas;
}

const Sprites = {
    run1: parseSprite(SpriteMaps.marineRun1, 4),
    run2: parseSprite(SpriteMaps.marineRun2, 4),
    alien: parseSprite(SpriteMaps.alien, 4),
    drone: parseSprite(SpriteMaps.drone, 4)
};

/**
 * ------------------------------------------------------------------
 * 3. AUDIO ENGINE (Music & SFX)
 * ------------------------------------------------------------------
 */
const AudioContext = window.AudioContext || window.webkitAudioContext;
const actx = new AudioContext();

const Tunes = {
    // A simple NES-style bassline loop
    bass: [110, 110, 146, 130, 98, 98, 130, 123], 
    lead: [0, 0, 440, 0, 0, 0, 523, 0] 
};

const Sfx = {
    play: (freq, type, dur, vol=0.1) => {
        if(actx.state==='suspended') actx.resume();
        const o = actx.createOscillator();
        const g = actx.createGain();
        o.type = type;
        o.frequency.setValueAtTime(freq, actx.currentTime);
        g.gain.setValueAtTime(vol, actx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, actx.currentTime + dur);
        o.connect(g); g.connect(actx.destination);
        o.start(); o.stop(actx.currentTime + dur);
    },
    jump: () => {
        const o = actx.createOscillator();
        const g = actx.createGain();
        o.frequency.setValueAtTime(150, actx.currentTime);
        o.frequency.linearRampToValueAtTime(400, actx.currentTime + 0.1);
        g.gain.setValueAtTime(0.1, actx.currentTime);
        g.gain.linearRampToValueAtTime(0, actx.currentTime + 0.1);
        o.connect(g); g.connect(actx.destination);
        o.start(); o.stop(actx.currentTime + 0.1);
    },
    tick: (beat) => {
        // Music Sequencer
        let bStep = Math.floor(beat / 12) % 8;
        if (beat % 12 === 0) Sfx.play(Tunes.bass[bStep], 'triangle', 0.1, 0.1);
        if (beat % 12 === 0 && Tunes.lead[bStep] > 0) Sfx.play(Tunes.lead[bStep], 'square', 0.1, 0.05);
    }
};

/**
 * ------------------------------------------------------------------
 * 4. GAME LOGIC
 * ------------------------------------------------------------------
 */
let state = 'MENU';
let frames = 0, score = 0, speed = 6;
let player = { x:100, y:0, dy:0, grounded:false, anim:0 };
let enemies = [], bullets = [], particles = [];

function startGame() {
    state = 'PLAYING';
    score = 0; speed = 7; frames = 0;
    enemies = []; bullets = []; particles = [];
    player.y = 400; player.dy = 0;
    document.getElementById('startScreen').classList.add('hidden');
    document.getElementById('gameOverScreen').classList.add('hidden');
    actx.resume();
    loop();
}

function loop() {
    if (state !== 'PLAYING') return;
    
    // Clear
    ctx.fillStyle = '#050510'; ctx.fillRect(0,0,960,540);
    
    // Starfield
    ctx.fillStyle = '#fff';
    for(let i=0; i<20; i++) ctx.fillRect((frames*i*2)%960, (i*43)%540, 2, 2);

    // Ground
    ctx.fillStyle = '#111'; ctx.fillRect(0, 500, 960, 40);
    ctx.fillStyle = '#00ff88'; ctx.fillRect(0, 500, 960, 2);

    // Music
    Sfx.tick(frames);

    // Logic
    frames++; score++; speed += 0.001;
    document.getElementById('scoreVal').innerText = score;

    // Player
    player.dy += 0.6; player.y += player.dy;
    if(player.y > 452) { player.y = 452; player.dy = 0; player.grounded = true; }
    else player.grounded = false;
    
    let pSprite = (!player.grounded) ? Sprites.run2 : (Math.floor(frames/6)%2==0 ? Sprites.run1 : Sprites.run2);
    ctx.drawImage(pSprite, player.x, player.y);

    // Spawner
    if (frames % Math.floor(1000/speed) === 0) {
        let isAir = Math.random() > 0.7;
        enemies.push({
            x: 960, y: isAir ? 350 : 455,
            type: isAir ? 'drone' : 'alien',
            dead: false
        });
    }

    // Enemies
    enemies.forEach(e => {
        e.x -= speed * (e.type==='drone'?1.2:1); // Drones vary speed
        ctx.drawImage(Sprites[e.type], e.x, e.y);
        
        // Collision
        if (!e.dead && 
            player.x < e.x+40 && player.x+40 > e.x && 
            player.y < e.y+40 && player.y+40 > e.y) {
             endGame();
        }
    });

    // Bullets
    bullets.forEach(b => {
        b.x += 15;
        ctx.fillStyle = '#fff'; ctx.fillRect(b.x, b.y, 10, 4);
        
        // Hit Detect
        enemies.forEach(e => {
            if (!e.dead && b.x < e.x+40 && b.x+10 > e.x && b.y < e.y+40 && b.y+4 > e.y) {
                e.dead = true; b.dead = true;
                score += 100;
                Sfx.play(100, 'noise', 0.1);
                spawnParticles(e.x, e.y, '#f05');
            }
        });
    });
    
    // Cleanup
    enemies = enemies.filter(e => e.x > -50 && !e.dead);
    bullets = bullets.filter(b => b.x < 1000 && !b.dead);
    
    // Particles
    particles.forEach(p => {
        p.x += p.vx; p.y += p.vy; p.life -= 0.1;
        ctx.fillStyle = p.c; ctx.fillRect(p.x, p.y, 4, 4);
    });
    particles = particles.filter(p => p.life > 0);

    requestAnimationFrame(loop);
}

function endGame() {
    state = 'GAMEOVER';
    Sfx.play(100, 'sawtooth', 0.5);
    document.getElementById('finalScore').innerText = score;
    document.getElementById('gameOverScreen').classList.remove('hidden');
}

function spawnParticles(x, y, c) {
    for(let i=0; i<8; i++) particles.push({x, y, vx:(Math.random()-.5)*10, vy:(Math.random()-.5)*10, life:1, c});
}

// Controls
window.addEventListener('keydown', e => {
    if (e.code === 'Space' && state === 'PLAYING') {
        if (player.grounded || player.dy > 0) { 
            player.dy = -13; Sfx.jump();
        }
    }
    if (e.code === 'KeyX' && state === 'PLAYING') {
        bullets.push({x: player.x+40, y: player.y+20, dead:false});
        Sfx.play(600, 'square', 0.05);
    }
});

// Leaderboard
async function loadLB() {
    if(LEADERBOARD_URL.includes("PASTE")) return;
    try {
        let r = await fetch(LEADERBOARD_URL);
        let d = await r.json();
        document.getElementById('startLeaderboard').innerHTML = d.map(r=>
            `<div class="lb-row"><span>${r[0]}</span><span>${r[1]}</span></div>`
        ).join('');
    } catch(e){}
}
async function submitScore() {
    let n = document.getElementById('playerName').value;
    if(!n) return alert("ENTER NAME");
    document.getElementById('submitBtn').innerText = "SENDING...";
    await fetch(LEADERBOARD_URL, {
        method:'POST', mode:'no-cors',
        body: JSON.stringify({name:n, score:score})
    });
    location.reload();
}
function resetGame() { location.reload(); }

loadLB();
</script>
</body>
</html>
