<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>SPRINGFIELD HORROR RUN</title>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Bangers&display=swap');
    
    * { box-sizing: border-box; touch-action: none; }
    
    body { 
        margin: 0; 
        background: #FFD90F; /* Simpsons Yellow */
        overflow: hidden; 
        font-family: 'Bangers', cursive; 
        display: flex; justify-content: center; align-items: center; 
        height: 100vh; user-select: none; 
    }

    #gameWrapper { 
        position: relative; 
        width: 100%; max-width: 854px; 
        aspect-ratio: 16/9;
        background: #42a4f5; 
        border: 6px solid #000; 
        box-shadow: 10px 10px 0px rgba(0,0,0,0.2); 
        overflow: hidden; 
    }

    canvas { width: 100%; height: 100%; display: block; }

    /* GIF LAYERS */
    .game-entity {
        position: absolute;
        pointer-events: none;
        image-rendering: pixelated; 
        transform: translate(-50%, -50%);
        z-index: 5;
    }
    
    #playerGif { z-index: 10; height: 18%; width: auto; }
    
    /* UI ELEMENTS */
    .overlay { 
        position: absolute; top:0; left:0; width:100%; height:100%; 
        background: rgba(0,0,0,0.7); 
        display: flex; flex-direction: column; align-items: center; justify-content: center; 
        z-index: 50; 
    }
    .hidden { display: none !important; }
    
    h1 { 
        font-size: clamp(40px, 8vw, 80px); 
        color: #FFD90F; 
        -webkit-text-stroke: 3px black;
        text-shadow: 5px 5px #000; 
        margin: 0; line-height: 1; 
        transform: rotate(-3deg);
    }
    
    .hud { 
        position: absolute; top: 15px; left: 20px; right: 20px; 
        display: flex; justify-content: space-between; 
        font-size: 24px; color: #fff; 
        text-shadow: 3px 3px 0 #000;
        z-index: 40; pointer-events: none; 
    }
    
    .fire-btn { 
        position: absolute; bottom: 30px; right: 30px; 
        width: 90px; height: 90px; border-radius: 50%; 
        background: #FFD90F; border: 4px solid #000; 
        color:black; font-size: 20px; display:flex; 
        align-items:center; justify-content:center; z-index:45; 
        box-shadow: 4px 4px 0 #000;
    }
    .fire-btn:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0 #000; }

    input { 
        background: #fff; border: 4px solid #000; color: #000; 
        padding: 10px; font-family: inherit; font-size: 20px; 
        width: 300px; text-align: center; margin-top: 20px; 
        text-transform: uppercase; 
    }
    
    button.menu-btn { 
        background: #FFD90F; color: #000; border: 4px solid #000; 
        padding: 10px 30px; font-family: inherit; font-size: 24px; 
        margin-top: 15px; cursor: pointer; 
        box-shadow: 6px 6px 0 #000; transition: transform 0.1s;
    }
    button.menu-btn:hover { transform: scale(1.05); }

    #lbContainer {
        margin-top: 20px; font-size: 16px; color: #fff; text-align: left;
        background: rgba(0,0,0,0.8); padding: 15px; border: 2px solid #FFD90F;
        border-radius: 10px; min-width: 300px;
    }
    .lb-row { display: flex; justify-content: space-between; margin-bottom: 5px; border-bottom: 1px dashed #555;}
    .lb-row span:last-child { color: #FFD90F; }

    #asset-pool { display: none; }
</style>
</head>
<body>

<audio id="bgMusic" src="simpsons.mp3" loop preload="auto"></audio>

<div id="asset-pool">
    <img id="src_player" src="player.gif">
    <img id="src_devil" src="devil.gif">
    <img id="src_monster" src="monster.gif">
    <img id="src_ninja" src="ninja.gif">
    <img id="src_ufo" src="ufo.gif">
</div>

<div id="gameWrapper">
    <div class="hud">
        <span>SCORE: <span id="scoreVal">0</span></span>
        <span>SPEED: <span id="spdVal">100%</span></span>
    </div>

    <img id="playerGif" class="game-entity" src="player.gif">
    <div id="enemyLayer"></div>

    <div id="startScreen" class="overlay">
        <h1>SPRINGFIELD<br>HORROR RUN</h1>
        <div style="text-align:center; font-size:18px; color:#fff; text-shadow:2px 2px #000; margin-top:10px;">
            [SPACE] JUMP / DOUBLE JUMP<br>[X] SLINGSHOT
        </div>
        <button class="menu-btn" onclick="startGame()">START GAME</button>
        <div id="lbContainer">LOADING...</div>
        <div id="statusMsg" style="font-size:12px; color:#ddd; margin-top:10px;">Checking Assets...</div>
    </div>

    <div id="gameOverScreen" class="overlay hidden">
        <h1 style="color:#FF4444; transform:rotate(3deg);">AY CARAMBA!</h1>
        <p style="color:#fff; font-size:24px; text-shadow:2px 2px #000;">SCORE: <span id="finalScore">0</span></p>
        <input type="text" id="playerName" placeholder="YOUR NAME" maxlength="15">
        <button class="menu-btn" onclick="submitScore()" id="subBtn">SAVE SCORE</button>
        <button class="menu-btn" onclick="location.reload()" style="background:#fff;">RETRY</button>
    </div>

    <div class="fire-btn" id="mobFire">POW</div>
    <canvas id="c"></canvas>
</div>

<script>
const LEADERBOARD_URL = "https://script.google.com/macros/s/AKfycbyPAOLu61io_asry-ThXGVjqYbmCTN7DtvSvvAyl25J1DROrta614m_uXGTDMFqwomv/exec"; 

// --- ASSET CHECK ---
window.onload = () => {
    const assets = ['player','devil','monster','ninja','ufo'];
    let loaded = 0;
    assets.forEach(a => {
        const img = document.getElementById('src_'+a);
        if(img.complete && img.naturalHeight !== 0) loaded++;
    });
    
    // Check Audio
    const aud = document.getElementById('bgMusic');
    aud.volume = 0.5; // Set volume to 50%
    
    const status = document.getElementById('statusMsg');
    if(loaded === 5) {
        status.innerText = "ALL ASSETS LOADED.";
        status.style.color = "#4f4";
    } else {
        status.innerText = "WARNING: GIFS MISSING. CHECK FILENAMES.";
        status.style.color = "#f44";
    }
};

// --- SFX ENGINE (Just Sound Effects now) ---
const Actx = window.AudioContext||window.webkitAudioContext; const actx = new Actx();
const SFX = {
    play: (f,t,d,v=0.1, slide=0) => {
        if(actx.state==='suspended')actx.resume();
        const o=actx.createOscillator(), g=actx.createGain();
        o.type=t; o.frequency.setValueAtTime(f, actx.currentTime);
        if(slide!==0) o.frequency.linearRampToValueAtTime(f+slide, actx.currentTime+d);
        g.gain.setValueAtTime(v, actx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, actx.currentTime+d);
        o.connect(g); g.connect(actx.destination); o.start(); o.stop(actx.currentTime+d);
    },
    jump: () => SFX.play(200, 'triangle', 0.2, 0.1, 150),
    shoot: () => SFX.play(600, 'sawtooth', 0.1, 0.1, -300)
};

// --- GAME LOGIC ---
const C = document.getElementById('c'), ctx = C.getContext('2d');
const W = 854, H = 480;
C.width = W; C.height = H;

let state='MENU', frames=0, score=0, difficulty=1;
let player = { x:100, y:350, dy:0, grounded:true, jumps:0 };
let enemies = [], bullets = [], clouds = [];

// Init Clouds
for(let i=0; i<10; i++) clouds.push({x:Math.random()*W, y:Math.random()*200, s:Math.random()*0.5+0.5});

function startGame() {
    state='PLAYING'; score=0; frames=0; difficulty=1;
    enemies.forEach(e => e.el.remove()); 
    enemies=[]; bullets=[];
    
    // Play Music
    const music = document.getElementById('bgMusic');
    music.currentTime = 0;
    music.play().catch(e => console.log("Audio play failed (user didn't interact?)"));
    
    document.getElementById('startScreen').classList.add('hidden');
    document.getElementById('playerGif').style.display = 'block';
    loop();
}

function loop() {
    if(state!=='PLAYING') return;
    frames++; score++;
    
    // Difficulty
    if(score%500===0) difficulty++;
    let speed = 5 + (difficulty * 0.5);
    if(speed > 15) speed = 15;
    
    document.getElementById('scoreVal').innerText = score;
    document.getElementById('spdVal').innerText = Math.floor((speed/5)*100) + "%";

    // --- PHYSICS ---
    player.dy += 0.8; // Gravity
    player.y += player.dy;
    
    // Ground
    let floorY = 380;
    if (player.y >= floorY) {
        player.y = floorY; 
        player.dy = 0; 
        player.grounded = true;
        player.jumps = 0; // Reset double jump
    }

    // --- SPAWNING ---
    let spawnRate = Math.max(50, 110 - (difficulty * 4));
    if(frames % spawnRate === 0) {
        let r = Math.random();
        let type = 'monster'; 
        let y = floorY + 10;
        
        if(r > 0.3) type = 'devil';
        if(r > 0.6) type = 'ninja';
        if(r > 0.85) { type = 'ufo'; y = floorY - 60 - Math.random()*50; } // Flying
        
        let img = document.createElement('img');
        img.src = type + '.gif';
        img.className = 'game-entity';
        
        // Sizing
        if(type==='ufo') img.style.height = '14%'; 
        else img.style.height = '18%'; 
        
        document.getElementById('enemyLayer').appendChild(img);
        
        enemies.push({
            type: type,
            x: W, y: y,
            w: 50, h: 80,
            el: img,
            dead: false
        });
    }

    // --- DRAWING ---
    ctx.clearRect(0,0,W,H);
    
    // Clouds
    ctx.fillStyle = '#fff';
    clouds.forEach(c => {
        c.x -= speed * 0.1 * c.s;
        if(c.x < -100) c.x = W + 100;
        ctx.beginPath();
        ctx.arc(c.x, c.y, 30*c.s, 0, Math.PI*2);
        ctx.arc(c.x+20*c.s, c.y-10*c.s, 40*c.s, 0, Math.PI*2);
        ctx.fill();
    });

    // Floor
    ctx.fillStyle = '#999'; ctx.fillRect(0, floorY + 40, W, H - floorY); 
    ctx.fillStyle = '#4d4'; ctx.fillRect(0, floorY + 35, W, 5); 

    // Update Player GIF
    const pGif = document.getElementById('playerGif');
    pGif.style.left = player.x + 'px';
    pGif.style.top = (player.y - 20) + 'px';

    // Enemies
    enemies.forEach(e => {
        e.x -= speed;
        
        // Dead logic: Fall through floor
        if(e.dead) {
            e.y += 5; // Fall down
            e.el.style.opacity = parseFloat(e.el.style.opacity || 1) - 0.05;
        }

        e.el.style.left = e.x + 'px';
        e.el.style.top = (e.y - 30) + 'px'; 
        
        // Collision (Only if alive)
        if(!e.dead) {
            if( player.x < e.x + 30 && player.x + 30 > e.x &&
                player.y < e.y + 10 && player.y + 70 > e.y - 50 ) {
                gameOver();
            }
        }
    });

    // Bullets
    bullets.forEach(b => {
        b.x += 10;
        ctx.fillStyle = 'red';
        ctx.beginPath(); ctx.arc(b.x, b.y, 5, 0, Math.PI*2); ctx.fill();
        
        // Hit Check
        enemies.forEach(e => {
            if(!e.dead && !b.dead && b.x > e.x - 20 && b.x < e.x + 20 && b.y > e.y - 80 && b.y < e.y) {
                e.dead = true;
                b.dead = true;
                score += 100;
                SFX.play(100, 'square', 0.1); 
            }
        });
    });

    // Cleanup
    enemies = enemies.filter(e => {
        if(e.x < -100 || e.y > H + 100) { e.el.remove(); return false; }
        return true;
    });
    bullets = bullets.filter(b => b.x < W);

    requestAnimationFrame(loop);
}

function gameOver() {
    state='GAMEOVER'; 
    document.getElementById('bgMusic').pause(); // Stop music
    SFX.play(100, 'sawtooth', 0.5, 0.3, -50); // Fail sound
    document.getElementById('finalScore').innerText=score;
    document.getElementById('gameOverScreen').classList.remove('hidden');
}

function jump() { 
    if(player.grounded || player.jumps < 2) { 
        player.dy = -13; 
        player.grounded = false; 
        player.jumps++;
        SFX.jump(); 
    } 
}
function shoot() { 
    bullets.push({x:player.x, y:player.y - 30, dead:false}); 
    SFX.shoot(); 
}

// CONTROLS
window.addEventListener('keydown', e=>{ 
    if(e.code==='Space' || e.code==='ArrowUp') jump(); 
    if(e.code==='KeyX') shoot(); 
});
document.getElementById('gameWrapper').addEventListener('touchstart', e=>{
    if(e.target.id!=='mobFire' && e.target.tagName!=='BUTTON') { e.preventDefault(); jump(); }
});
document.getElementById('mobFire').addEventListener('touchstart', (e)=>{ 
    e.stopPropagation(); e.preventDefault(); shoot(); 
});
document.getElementById('mobFire').addEventListener('mousedown', (e)=>{ 
    e.stopPropagation(); shoot(); 
});

// LEADERBOARD
async function submitScore() {
    let n = document.getElementById('playerName').value; if(!n) return alert("ENTER NAME");
    document.getElementById('subBtn').innerText = "...";
    try {
        await fetch(LEADERBOARD_URL, {method:'POST', mode:'no-cors', body:JSON.stringify({name:n, score:score})});
        alert("SCORE SAVED!"); location.reload();
    } catch(e) { alert("ERROR"); }
}

async function loadLB() {
    try {
        let r = await fetch(LEADERBOARD_URL);
        let d = await r.json();
        let h = d.sort((a,b)=>b[1]-a[1]).slice(0,5).map(r=>`<div class="lb-row"><span>${r[0]}</span><span>${r[1]}</span></div>`).join('');
        document.getElementById('lbContainer').innerHTML = "TOP 5:<br>" + h;
    } catch(e){ document.getElementById('lbContainer').innerText = "LB OFFLINE"; }
}
loadLB();
</script>
</body>
</html>
